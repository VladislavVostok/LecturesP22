Для связей между сущностями в Entity Framework Core применяются внешние ключи и навигационные свойства. Так, возьмем к примеру следующие сущности:

```cs
public class Company

{

    public int Id { get; set; }

    public string? Name { get; set; } // название компании

    public List<User> Users { get; set; } = new();

}

public class User

{

    public int Id { get; set; }

    public string? Name { get; set; }

    public int CompanyId { get; set; }      // внешний ключ

    public Company? Company { get; set; }    // навигационное свойство

}
```

И пусть у нас будет следующий контекст данных:

|                                                                                                                                                 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| ----------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| 1<br><br>2<br><br>3<br><br>4<br><br>5<br><br>6<br><br>7<br><br>8<br><br>9<br><br>10<br><br>11<br><br>12<br><br>13<br><br>14<br><br>15<br><br>16 | `using` `Microsoft.EntityFrameworkCore;`<br><br>`public` `class` `ApplicationContext : DbContext`<br><br>`{`<br><br>    `public` `DbSet<User> Users {` `get``;` `set``; } =` `null``!;`<br><br>    `public` `DbSet<Company> Companies {` `get``;` `set``; } =` `null``!;`<br><br>    `public` `ApplicationContext()`<br><br>    `{`<br><br>        `Database.EnsureDeleted();`<br><br>        `Database.EnsureCreated();`<br><br>    `}`<br><br>    `protected` `override` `void` `OnConfiguring(DbContextOptionsBuilder optionsBuilder)`<br><br>    `{`<br><br>        `optionsBuilder.UseSqlite(``"Data Source=helloapp.db"``);`<br><br>    `}`<br><br>`}` |

В данном случае сущность Company является главной сущностью, а класс User - зависимой, так как содержит ссылку на класс Company и зависит от этого класса.

Свойство `CompanyId` в классе User является внешним ключом, а свойство `Company` - навигационным свойством. По умолчанию название внешнего ключа должно принимать одно из следующих вариантов имени:

- Имя_навигационного_свойства+Имя ключа из связанной сущности - в нашем случае имя навигационного свойства Company, а ключа из модели Company - Id, поэтому в нашем случае нам надо обозвать свойство CompanyId, что собственно и было сделано в вышеприведенном коде.
    
- Имя_класса_связанной_сущности+Имя ключа из связанной сущности - в нашем случае класс Company, а имя ключа из модели Company - Id, поэтому опять же в этом случае получается CompanyId
    

Свойство `Users`, представляющее список пользователей компании, в классе Company также является навигационным свойством.

В итоге после генерации базы данных в случае с SQLite таблицы будут иметь следующее определение:

|                                                                                                                   |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| ----------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 1<br><br>2<br><br>3<br><br>4<br><br>5<br><br>6<br><br>7<br><br>8<br><br>9<br><br>10<br><br>11<br><br>12<br><br>13 | `CREATE` `TABLE` `"Users"` `(`<br><br>    `"Id"`    `INTEGER` `NOT` `NULL``,`<br><br>    `"Name"`  `TEXT,`<br><br>    `"CompanyId"` `INTEGER` `NOT` `NULL``,`<br><br>    `CONSTRAINT` `"FK_Users_Companies_CompanyId"` `FOREIGN` `KEY``(``"CompanyId"``)` `REFERENCES` `"Companies"``(``"Id"``)` `ON` `DELETE` `CASCADE``,`<br><br>    `CONSTRAINT` `"PK_Users"` `PRIMARY` `KEY``(``"Id"` `AUTOINCREMENT)`<br><br>`);`<br><br>`CREATE` `TABLE` `"Companies"` `(`<br><br>    `"Id"`    `INTEGER` `NOT` `NULL``,`<br><br>    `"Name"`  `TEXT,`<br><br>    `CONSTRAINT` `"PK_Companies"` `PRIMARY` `KEY``(``"Id"` `AUTOINCREMENT)`<br><br>`);` |

#### Установка главной сущности по навигационному свойству зависимой сущности

Причем при использовании классов нам достаточно установить либо одно навигационное свойство, либо свойство-внешний ключ. Например, укажем значение только для навигационного свойства:

|                                                                                                                                                           |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| --------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 1<br><br>2<br><br>3<br><br>4<br><br>5<br><br>6<br><br>7<br><br>8<br><br>9<br><br>10<br><br>11<br><br>12<br><br>13<br><br>14<br><br>15<br><br>16<br><br>17 | `using` `(ApplicationContext db =` `new` `ApplicationContext())`<br><br>`{`<br><br>    `Company company1 =` `new` `Company { Name =` `"Google"` `};`<br><br>    `Company company2 =` `new` `Company { Name =` `"Microsoft"` `};`<br><br>    `User user1 =` `new` `User { Name =` `"Tom"``, Company = company1 };`<br><br>    `User user2 =` `new` `User { Name =` `"Bob"``, Company = company2 };`<br><br>    `User user3 =` `new` `User { Name =` `"Sam"``, Company = company2 };`<br><br>    `db.Companies.AddRange(company1, company2);`  `// добавление компаний`<br><br>    `db.Users.AddRange(user1, user2, user3);`     `// добавление пользователей`<br><br>    `db.SaveChanges();`<br><br>    `foreach` `(var user` `in` `db.Users.ToList())`<br><br>    `{`<br><br>        `Console.WriteLine($``"{user.Name} работает в {user.Company?.Name}"``);`<br><br>    `}`<br><br>`}` |

Консольный вывод программы:

Tom работает в Google
Bob работает в Microsoft
Sam работает в Microsoft

#### Установка главной сущности по свойству-внешнему ключу зависимой сущности

Также можно использовать свойство-внешний ключ для установки связи:

|                                                                                                                                                                               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 1<br><br>2<br><br>3<br><br>4<br><br>5<br><br>6<br><br>7<br><br>8<br><br>9<br><br>10<br><br>11<br><br>12<br><br>13<br><br>14<br><br>15<br><br>16<br><br>17<br><br>18<br><br>19 | `using` `(ApplicationContext db =` `new` `ApplicationContext())`<br><br>`{`<br><br>    `Company company1 =` `new` `Company { Name =` `"Google"` `};`<br><br>    `Company company2 =` `new` `Company { Name =` `"Microsoft"` `};`<br><br>    `db.Companies.AddRange(company1, company2);`  `// добавление компаний`<br><br>    `db.SaveChanges();`<br><br>    `User user1 =` `new` `User { Name =` `"Tom"``, CompanyId = company1.Id };`<br><br>    `User user2 =` `new` `User { Name =` `"Bob"``, CompanyId = company1.Id };`<br><br>    `User user3 =` `new` `User { Name =` `"Sam"``, CompanyId = company2.Id };`<br><br>    `db.Users.AddRange(user1, user2, user3);`     `// добавление пользователей`<br><br>    `db.SaveChanges();`<br><br>    `foreach` `(var user` `in` `db.Users.ToList())`<br><br>    `{`<br><br>        `Console.WriteLine($``"{user.Name} работает в {user.Company?.Name}"``);`<br><br>    `}`<br><br>`}` |

Здесь надо отметить один момент: для устновки свойства внешнего ключа CompanyId нам необходимо знать его значение. Однако посколько оно связано со свойством Id класса Company, значение которого генерируется при добавление объекта в БД, соответственно в данном случае необходимо сначала добавить объект Company в базу данных.

#### Установка зависимой сущности через навигационное свойство главной сущности

Выше для установки связи применялась зависимая сущность - User. Но мы также можем зайти с другой стороны и установить набор зависимых сущностей через навигационное свойство главной сущности:

|                                                                                                                                                                     |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| ------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 1<br><br>2<br><br>3<br><br>4<br><br>5<br><br>6<br><br>7<br><br>8<br><br>9<br><br>10<br><br>11<br><br>12<br><br>13<br><br>14<br><br>15<br><br>16<br><br>17<br><br>18 | `using` `(ApplicationContext db =` `new` `ApplicationContext())`<br><br>`{`<br><br>    `User user1 =` `new` `User { Name =` `"Tom"``};`<br><br>    `User user2 =` `new` `User { Name =` `"Bob"` `};`<br><br>    `User user3 =` `new` `User { Name =` `"Sam"``};`<br><br>    `Company company1 =` `new` `Company { Name =` `"Google"``, Users = { user1, user2} };`<br><br>    `Company company2 =` `new` `Company { Name =` `"Microsoft"``, Users = { user3 } };`<br><br>    `db.Companies.AddRange(company1, company2);`  `// добавление компаний`<br><br>    `db.Users.AddRange(user1, user2, user3);`     `// добавление пользователей`<br><br>    `db.SaveChanges();`<br><br>    `foreach` `(var user` `in` `db.Users.ToList())`<br><br>    `{`<br><br>        `Console.WriteLine($``"{user.Name} работает в {user.Company?.Name}"``);`<br><br>    `}`<br><br>`}` |

### Отсутствие свойства внешнего ключа и навигационного свойства

Нам необязательно определять внешний ключ в зависимой сущности. Его можно опустить:

|                                                         |                                                                                                                                                                                                                                                          |
| ------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 1<br><br>2<br><br>3<br><br>4<br><br>5<br><br>6<br><br>7 | `public` `class` `User`<br><br>`{`<br><br>    `public` `int` `Id {` `get``;` `set``; }`<br><br>    `public` `string``? Name {` `get``;` `set``; }`<br><br>    `public` `Company? Company {` `get``;` `set``; }`   `// навигационное свойство`<br><br>`}` |

В этом случае Entity Framework сам автоматически сгенерирует столбец для внешнего ключа в таблице Users.

|                                                         |                                                                                                                                                                                                                                                                                                                                                                                 |
| ------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 1<br><br>2<br><br>3<br><br>4<br><br>5<br><br>6<br><br>7 | `CREATE` `TABLE` `"Users"` `(`<br><br>    `"Id"`    `INTEGER` `NOT` `NULL``,`<br><br>    `"Name"`  `TEXT,`<br><br>    `"CompanyId"` `INTEGER``,`<br><br>    `CONSTRAINT` `"PK_Users"` `PRIMARY` `KEY``(``"Id"` `AUTOINCREMENT),`<br><br>    `CONSTRAINT` `"FK_Users_Companies_CompanyId"` `FOREIGN` `KEY``(``"CompanyId"``)` `REFERENCES` `"Companies"``(``"Id"``)`<br><br>`);` |

Преимущество определения внешнего ключа в качестве свойства состоит в том, что в каких-то ситуациях нам может потребоваться только id связанной сущности. Тем более столбец для внешнего ключа в таблице в любом случае создается.

Более того, мы можем вовсе опустить навигационное свойство в классе User:

|                                       |                                                                                                                                                              |
| ------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| 1<br><br>2<br><br>3<br><br>4<br><br>5 | `public` `class` `User`<br><br>`{`<br><br>    `public` `int` `Id {` `get``;` `set``; }`<br><br>    `public` `string` `Name {` `get``;` `set``; }`<br><br>`}` |

Но за счет того, что в классе Company также определено навигационное свойство Users все равно будет создаваться внешний ключ и связь таблицы Users и таблицы Companies. В частности, тогда в случае БД SQLite определение таблицы Users будет выглядеть следующим образом:

|                                                         |                                                                                                                                                                                                                                                                                                                                                                                 |
| ------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 1<br><br>2<br><br>3<br><br>4<br><br>5<br><br>6<br><br>7 | `CREATE` `TABLE` `"Users"` `(`<br><br>    `"Id"`    `INTEGER` `NOT` `NULL``,`<br><br>    `"Name"`  `TEXT,`<br><br>    `"CompanyId"` `INTEGER``,`<br><br>    `CONSTRAINT` `"FK_Users_Companies_CompanyId"` `FOREIGN` `KEY``(``"CompanyId"``)` `REFERENCES` `"Companies"``(``"Id"``),`<br><br>    `CONSTRAINT` `"PK_Users"` `PRIMARY` `KEY``(``"Id"` `AUTOINCREMENT)`<br><br>`);` |

В отличие от первой версии таблицы здесь не добавляется каскадное удаление.